<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Work Order Equipment Display</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 1.5em;
      margin: 0;
      background-color: #f9f9f9;
    }
    
    #display {
      background-color: white;
      padding: 1.5em;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h3 {
      margin-top: 0;
      margin-bottom: 0.8em;
      color: #333;
      font-size: 1.1em;
      font-weight: 600;
    }
    
    .customer-name {
      font-size: 1.3em;
      color: #2c5aa0;
      margin-bottom: 1.5em;
    }
    
    ul {
      margin-top: 0.5em;
      padding-left: 1.5em;
      list-style-type: disc;
    }
    
    li {
      margin-bottom: 0.5em;
      color: #555;
    }
    
    .no-data {
      color: #999;
      font-style: italic;
    }
    
    .error {
      color: #d32f2f;
      background-color: #ffebee;
      padding: 1em;
      border-radius: 4px;
      border-left: 4px solid #d32f2f;
    }
    
    .loading {
      color: #666;
    }
  </style>
</head>
<body>
  <div id="display">
    <p class="loading">Waiting for data...</p>
  </div>
  
  <script>
    // Request full access to read from other tables
    grist.ready({ requiredAccess: 'full' });

    // Handle record changes
    grist.onRecord(async function(record) {
      try {
        console.log('Record received (display values):', record);
        
        // Fetch the record again with encoded values to get row IDs
        const encodedRecord = await grist.fetchSelectedRecord({ keepEncoded: true });
        console.log('Record with row IDs:', encodedRecord);
        
        // Get the Equipment_Worked_on reference list (now we get row IDs)
        const equipmentIds = encodedRecord.Equipment_Worked_on || [];
        console.log('Equipment row IDs:', equipmentIds);
        
        // Get the Company reference (now we get the row ID)
        const companyId = encodedRecord.Company;
        console.log('Company row ID:', companyId);
        
        let equipmentTypes = [];
        let customerName = '';
        
        // Fetch equipment types from COMPANY_EQUIPMENT table
        if (equipmentIds && equipmentIds.length > 0) {
          try {
            const equipmentTable = await grist.docApi.fetchTable('COMPANY_EQUIPMENT');
            console.log('Equipment table fetched:', equipmentTable);
            
            for (let equipId of equipmentIds) {
              const rowIndex = equipmentTable.id.indexOf(equipId);
              if (rowIndex !== -1 && equipmentTable.type) {
                const type = equipmentTable.type[rowIndex];
                if (type) {
                  equipmentTypes.push(type);
                }
              }
            }
          } catch (e) {
            console.error('Error fetching equipment table:', e);
          }
        }
        
        // Fetch customer name from COMPANIES table
        if (companyId) {
          try {
            const companiesTable = await grist.docApi.fetchTable('COMPANIES');
            console.log('Companies table fetched');
            
            const rowIndex = companiesTable.id.indexOf(companyId);
            console.log('Looking for company row ID:', companyId, 'Found at index:', rowIndex);
            
            if (rowIndex !== -1 && companiesTable.Customer) {
              customerName = companiesTable.Customer[rowIndex];
            }
          } catch (e) {
            console.error('Error fetching companies table:', e);
          }
        }
        
        console.log('Equipment types found:', equipmentTypes);
        console.log('Customer name found:', customerName);
        
        // Update the display
        const displayElement = document.getElementById('display');
        if (displayElement) {
          let html = '';
          
          // Display customer
          html += '<div class="customer-name">';
          html += '<strong>Customer:</strong> ';
          html += customerName ? customerName : '<span class="no-data">N/A</span>';
          html += '</div>';
          
          // Display equipment types
          html += '<h3>Equipment Types:</h3>';
          if (equipmentTypes.length > 0) {
            html += '<ul>';
            equipmentTypes.forEach(type => {
              html += `<li>${type}</li>`;
            });
            html += '</ul>';
          } else {
            html += '<p class="no-data">No equipment types found</p>';
          }
          
          displayElement.innerHTML = html;
        }
        
      } catch (error) {
        console.error('Error in widget:', error);
        const displayElement = document.getElementById('display');
        if (displayElement) {
          displayElement.innerHTML = `
            <div class="error">
              <strong>Error:</strong> ${error.message}
            </div>
          `;
        }
      }
    });
  </script>
</body>
</html>
